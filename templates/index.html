<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRM - GPU Resource Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">
                    <i class="fas fa-microchip"></i> GRM - GPU Resource Manager
                </h1>
                <p class="text-center text-muted mb-4">
                    <em>The CRM for GPU Infrastructure</em>
                </p>
                
                <!-- Professional Control Toolbar -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm">
                    <div class="container-fluid px-3">
                        <!-- GPU Type Selection -->
                        <div class="navbar-nav me-4">
                            <div class="nav-item">
                                <label class="text-light small mb-1 d-block">GPU Type</label>
                                <select id="gpuTypeSelect" class="form-select form-select-sm" style="min-width: 160px;">
                                    <option value="">Loading types...</option>
                                </select>
                                <small class="text-muted" id="backgroundLoadingStatus" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </small>
                            </div>
                        </div>

                        <!-- Host Search -->
                        <div class="navbar-nav flex-grow-1 me-4">
                            <div class="nav-item w-100">
                                <label class="text-light small mb-1 d-block">Search Hosts</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="globalSearch" class="form-control"
                                           placeholder="Hostname, customer, contract..." autocomplete="off">
                                    <button class="btn btn-outline-light" type="button" id="clearSearchBtn"
                                            title="Clear search" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Owner Filters -->
                        <div class="navbar-nav me-4">
                            <label class="text-light small mb-1 d-block">Owner Filters</label>
                            <div class="d-flex gap-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="filterInvestor" checked>
                                    <label class="form-check-label text-light small" for="filterInvestor">
                                        Investor Owned
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="filterNGC" checked>
                                    <label class="form-check-label text-light small" for="filterNGC">
                                        NGC
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons & Status -->
                        <div class="navbar-nav">
                            <div class="d-flex align-items-center gap-2">
                                <!-- Refresh Button -->
                                <button type="button" class="btn btn-primary btn-sm" onclick="refreshData()"
                                        title="Refresh all data">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>

                                <!-- Management Tools Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-tools"></i> Tools
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" data-bs-toggle="tab" data-bs-target="#pending">
                                            <i class="fas fa-clock"></i> Pending Operations
                                            <span class="badge bg-warning ms-2" id="pendingDropdownCount">0</span>
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" data-bs-toggle="tab" data-bs-target="#commands">
                                            <i class="fas fa-terminal"></i> Command Log
                                            <span class="badge bg-secondary ms-2" id="commandDropdownCount">0</span>
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" data-bs-toggle="tab" data-bs-target="#results">
                                            <i class="fas fa-chart-line"></i> Analytics
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" data-bs-toggle="tab" data-bs-target="#debug">
                                            <i class="fas fa-bug"></i> Debug
                                            <span class="badge bg-info ms-2" id="debugDropdownCount">45</span>
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><button class="dropdown-item" type="button" id="clear-cache-btn"
                                                    title="Clear caches without refreshing data">
                                            <i class="fas fa-trash text-warning"></i> Clear Cache
                                        </button></li>
                                    </ul>
                                </div>

                                <!-- Cache Status Indicator -->
                                <div class="text-light small" title="Cache status">
                                    <i class="fas fa-database"></i> <span id="cache-status">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- GPU Type Summary Cards -->
                <div id="gpuTypeSummary" class="row mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body py-3">
                                <div class="row align-items-center">
                                    <!-- GPU Usage Overview -->
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-microchip text-primary fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 text-primary">Total GPU Usage</h6>
                                                <div class="gpu-overview-stats">
                                                    <span class="badge bg-primary fs-6" id="totalGpuUsage">Not loaded</span>
                                                    <span class="badge bg-primary fs-6 ms-2" id="gpuUsagePercentage">-</span>
                                                </div>
                                                <small class="text-muted d-block">Active GPUs</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NetBox Inventory -->
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-database text-info fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 text-info">NetBox Inventory</h6>
                                                <span class="badge bg-info fs-6" id="netboxInventoryCount">-</span>
                                                <small class="text-muted d-block">Physical hosts</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Columns Total -->
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-columns text-success fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 text-success">Columns Total</h6>
                                                <span class="badge bg-success fs-6" id="columnsInventoryCount">-</span>
                                                <small class="d-block" id="inventoryStatus">
                                                    <i class="fas fa-sync-alt fa-spin text-muted"></i> Calculating...
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GPU Type Info -->
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-microchip text-warning fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 text-warning" id="selectedGpuTypeName">Select GPU Type</h6>
                                                <small class="text-muted d-block">
                                                    <span id="backgroundLoadingStatus" style="display: none;">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                                    </span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Info Row -->
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Use owner filters above to show only Investor Owned or NGC systems.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loadingMessage">Loading aggregate data...</p>
                    <div class="progress mt-2" style="height: 8px; max-width: 400px; margin: 0 auto;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%" 
                             id="loadingProgress">
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="loadingStep">Initializing...</small>
                </div>
                
                <!-- Main Content -->
                <div id="mainContent">
                    <!-- Simplified Tab Navigation - Focus on Main Content -->
                    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="hosts-tab" data-bs-toggle="tab" data-bs-target="#hosts" type="button" role="tab">
                                <i class="fas fa-server"></i> Host Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" style="display: none;">
                                <i class="fas fa-clock"></i> Pending Operations
                                <span class="badge bg-warning ms-1" id="pendingTabCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="commands-tab" data-bs-toggle="tab" data-bs-target="#commands" type="button" role="tab" style="display: none;">
                                <i class="fas fa-terminal"></i> Command Log
                                <span class="badge bg-secondary ms-1" id="commandCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab" style="display: none;">
                                <i class="fas fa-chart-pie"></i> Analytics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug" type="button" role="tab" style="display: none;">
                                <i class="fas fa-bug"></i> Debug
                                <span class="badge bg-info ms-1" id="debugTabCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="system-info-tab" data-bs-toggle="tab" data-bs-target="#system-info" type="button" role="tab" style="display: none;">
                                <i class="fas fa-info-circle"></i> System Info
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="mainTabContent">
                        <!-- Hosts Tab -->
                        <div class="tab-pane fade show active" id="hosts" role="tabpanel">
                            
                            <div class="row mt-3 hosts-row d-none" id="hostsRow">
                                
                                <!-- Runpod Column -->
                                <div class="col-md-2" style="flex: 0 0 20%;">
                                    <div class="aggregate-column" id="runpodColumn">
                                        <div class="card">
                                            <div class="card-header bg-purple text-white">
                                                <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-rocket"></i> 
                                                        <span id="runpodName">Runpod</span>
                                                        <span class="badge bg-light text-dark ms-2" id="runpodCount">0</span>
                                                    </span>
                                                </h4>
                                                <div class="mt-2">
                                                    <small class="text-light">GPU Usage: <span id="runpodGpuUsage">0/0</span> (<span id="runpodGpuPercent">0%</span>)</small>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="runpodGpuProgressBar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body drop-zone" id="runpodHosts" data-type="runpod">
                                                <!-- RunPod hosts will be dynamically inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- On-Demand Columns will be dynamically inserted here -->
                                
                                <!-- Fallback On-Demand Column (for compatibility) -->
                                <div class="col-md-2" id="ondemandColumnFallback" style="display: none; flex: 0 0 20%;">
                                    <div class="aggregate-column" id="ondemandColumn">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-server"></i> 
                                                        On-Demand <span id="ondemandName"></span>
                                                        <span class="badge bg-light text-dark ms-2" id="ondemandCount">0</span>
                                                    </span>
                                                </h4>
                                                <div class="mt-2">
                                                    <small class="text-light">GPU Usage: <span id="ondemandGpuUsage">0/0</span> (<span id="ondemandGpuPercent">0%</span>)</small>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="ondemandGpuProgressBar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body drop-zone" id="ondemandHosts" data-type="ondemand">
                                                <!-- On-demand hosts will be dynamically inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Spot Column -->
                                <div class="col-md-2" style="flex: 0 0 20%;">
                                    <div class="aggregate-column" id="spotColumn">
                                        <div class="card">
                                            <div class="card-header bg-warning text-dark">
                                                <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-flash"></i> 
                                                        <span id="spotName">Spot</span>
                                                        <span class="badge bg-light text-dark ms-2" id="spotCount">0</span>
                                                    </span>
                                                </h4>
                                                <div class="mt-2">
                                                    <small class="text-dark">GPU Usage: <span id="spotGpuUsage">0/0</span> (<span id="spotGpuPercent">0%</span>)</small>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-dark" role="progressbar" style="width: 0%" id="spotGpuProgressBar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body drop-zone" id="spotHosts" data-type="spot">
                                                <!-- Spot hosts will be dynamically inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contract Column -->
                                <div class="col-md-2" id="contractColumn" style="flex: 0 0 20%;">
                                    <div class="aggregate-column" id="contractAggregateColumn">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-file-contract"></i> 
                                                        <span id="contractName">Contract</span>
                                                        <span class="badge bg-light text-dark ms-2" id="contractHostCount">0</span>
                                                    </span>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-light me-1" id="customerViewToggleBtn" title="Toggle Customer View" onclick="toggleCustomerView()">
                                                            <i class="fas fa-expand"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="refreshContractBtn" title="Refresh Contract column">
                                                            <i class="fas fa-sync"></i>
                                                        </button>
                                                    </div>
                                                </h4>
                                                <div class="mt-2">
                                                    <small class="text-light">GPU Usage: <span id="contractGpuUsage">0/0</span> (<span id="contractGpuPercent">0%</span>)</small>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="contractGpuProgressBar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body drop-zone" id="contractHosts" data-type="contract">
                                                <!-- Contract Selection Controls -->
                                                <div class="mb-3" id="contractSelectionDiv">
                                                    <label for="contractColumnSelect" class="form-label">
                                                        <small>Contracts:</small>
                                                    </label>
                                                    <select id="contractColumnSelect" class="form-select form-select-sm mb-2">
                                                        <option value="">Show All Contracts</option>
                                                        <option value="__ALL__">Show All Contracts</option>
                                                    </select>
                                                    
                                                    <!-- Hide Empty Contracts Option -->
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="hideEmptyContracts" checked>
                                                        <label class="form-check-label" for="hideEmptyContracts">
                                                            <small>Hide empty contracts</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <!-- Contract hosts will be dynamically inserted here -->
                                                <div id="contractHostsList">
                                                    <div class="text-center text-muted" id="contractEmptyState">
                                                        <i class="fas fa-file-contract fa-2x mb-2"></i>
                                                        <p class="small">Select a contract above to view hosts</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Out of Stock Column (v0.2) -->
                                <div class="col-md-2" style="flex: 0 0 20%;">
                                    <div class="aggregate-column" id="outofstockColumn">
                                        <div class="card">
                                            <div class="card-header bg-danger text-white">
                                                <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        <span id="outofstockName">Out of Stock</span>
                                                        <span class="badge bg-light text-dark ms-2" id="outofstockCount">0</span>
                                                    </span>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-light me-1" id="outofstockInfoBtn"
                                                                title="View Out of Stock Reasons"
                                                                data-bs-toggle="modal" data-bs-target="#outofstockLegendModal">
                                                            <i class="fas fa-info-circle"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="refreshOutofstockBtn" title="Refresh Out of Stock">
                                                            <i class="fas fa-sync"></i>
                                                        </button>
                                                    </div>
                                                </h4>
                                                <div class="mt-2">
                                                    <small class="text-light">Unused: <span id="outofstockGpuUsage">0/0</span> (<span id="outofstockGpuPercent">0%</span>)</small>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="outofstockGpuProgressBar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body" id="outofstockHosts">
                                                <!-- Out of stock hosts will be dynamically inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Customer View (Hidden by default) -->
                            <div class="row" id="customerViewContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h4 class="mb-0">
                                                    <i class="fas fa-eye"></i>
                                                    Customer View - <span id="customerViewContractName"></span>
                                                </h4>
                                                <div class="d-flex align-items-center flex-wrap" id="customerViewControls">
                                                    <div class="me-3 mb-2">
                                                        <label class="form-label text-light mb-0 me-2">Contracts:</label>
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="contractMultiSelectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                <span id="selectedContractsText">Select Contracts...</span>
                                                            </button>
                                                            <ul class="dropdown-menu" aria-labelledby="contractMultiSelectDropdown" id="contractMultiSelectMenu" style="min-width: 300px;">
                                                                <!-- Contract checkboxes will be populated here -->
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-light mb-2" onclick="toggleCustomerView()" title="Close Customer View">
                                                        <i class="fas fa-compress"></i> Close
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Contract Statistics -->
                                            <div class="mt-2 px-3 pb-2" id="customerViewStats">
                                                <!-- Single Contract Stats -->
                                                <div class="row text-light" id="singleContractStats">
                                                    <div class="col-md-4">
                                                        <small class="d-block">Total GPU Usage</small>
                                                        <strong id="customerViewGpuUsage">0/0 GPUs</strong>
                                                        <div class="progress mt-1" style="height: 4px;">
                                                            <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="customerViewGpuProgressBar"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="d-block">Available Hosts</small>
                                                        <strong id="customerViewAvailableHosts">0</strong>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="d-block">Hosts in Use</small>
                                                        <strong id="customerViewInUseHosts">0</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Dual Contract Stats -->
                                                <div id="dualContractStats" style="display: none;">
                                                    <div class="row text-light">
                                                        <div class="col-md-6">
                                                            <div class="border-end border-light pe-3">
                                                                <small class="d-block"><strong id="contract1Name">Contract 1</strong></small>
                                                                <div class="mt-2">
                                                                    <small>GPU Usage:</small>
                                                                    <strong id="contract1GpuUsage" class="d-block">0/0 GPUs (0%)</strong>
                                                                    <div class="progress mt-1" style="height: 3px;">
                                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="contract1GpuProgressBar"></div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mt-2">
                                                                    <div class="col-6">
                                                                        <small>Available:</small>
                                                                        <strong id="contract1AvailableHosts" class="d-block">0</strong>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <small>In Use:</small>
                                                                        <strong id="contract1InUseHosts" class="d-block">0</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="ps-3">
                                                                <small class="d-block"><strong id="contract2Name">Contract 2</strong></small>
                                                                <div class="mt-2">
                                                                    <small>GPU Usage:</small>
                                                                    <strong id="contract2GpuUsage" class="d-block">0/0 GPUs (0%)</strong>
                                                                    <div class="progress mt-1" style="height: 3px;">
                                                                        <div class="progress-bar bg-light" role="progressbar" style="width: 0%" id="contract2GpuProgressBar"></div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mt-2">
                                                                    <div class="col-6">
                                                                        <small>Available:</small>
                                                                        <strong id="contract2AvailableHosts" class="d-block">0</strong>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <small>In Use:</small>
                                                                        <strong id="contract2InUseHosts" class="d-block">0</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-3">
                                            <!-- GPU Groups will be rendered here -->
                                            <div id="customerViewContent">
                                                <div class="text-center text-muted py-5">
                                                    <i class="fas fa-file-contract fa-3x mb-3"></i>
                                                    <h5>Select a contract to view devices</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- Pending Operations Tab -->
                        <div class="tab-pane fade" id="pending" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-warning text-dark">
                                            <h5 class="mb-0">
                                                <i class="fas fa-clock"></i> Pending Operations
                                                <span class="badge bg-dark ms-2" id="pendingCount">0</span>
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="pendingOperationsList" class="mb-3">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-clock fa-3x mb-3"></i>
                                                    <p>No pending operations. Select hosts and add operations to see them here.</p>
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <button id="commitBtn" class="btn btn-success me-2">
                                                    <i class="fas fa-check"></i> Commit Selected Operations
                                                </button>
                                                <button id="clearPendingBtn" class="btn btn-outline-danger me-2">
                                                    <i class="fas fa-times"></i> Clear All
                                                </button>
                                                <button id="selectAllPendingBtn" class="btn btn-outline-primary me-2">
                                                    <i class="fas fa-check-square"></i> Select All
                                                </button>
                                                <button id="deselectAllPendingBtn" class="btn btn-outline-secondary">
                                                    <i class="fas fa-square"></i> Deselect All
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Commands Tab -->
                        <div class="tab-pane fade" id="commands" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-terminal"></i> Command Execution Log
                                            </h5>
                                            <div>
                                                <button id="refreshLogBtn" class="btn btn-sm btn-outline-secondary me-2">
                                                    <i class="fas fa-sync"></i> Refresh
                                                </button>
                                                <button id="clearLogBtn" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i> Clear Log
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="commandLogContainer">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-terminal fa-3x mb-3"></i>
                                                    <p>No commands executed yet. Commands will appear here when you perform migrations.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Tab -->
                        <div class="tab-pane fade" id="results" role="tabpanel">
                            <div class="row mt-3">
                                <!-- Execution Statistics -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-pie"></i> Execution Statistics
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="resultsSummary">
                                                <div class="row">
                                                    <div class="col-6 mb-3">
                                                        <div class="stat-card success">
                                                            <div class="stat-value" id="successCount">0</div>
                                                            <div class="stat-label">Successful</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 mb-3">
                                                        <div class="stat-card error">
                                                            <div class="stat-value" id="errorCount">0</div>
                                                            <div class="stat-label">Failed</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="stat-card preview">
                                                            <div class="stat-value" id="previewCount">0</div>
                                                            <div class="stat-label">Previewed</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="stat-card total">
                                                            <div class="stat-value" id="totalCount">0</div>
                                                            <div class="stat-label">Total</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Session Analytics -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-clock"></i> Session Analytics
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-12 mb-3">
                                                    <div class="analytics-item">
                                                        <i class="fas fa-play-circle text-primary me-2"></i>
                                                        <strong>Session Started:</strong>
                                                        <span id="sessionStartTime">Loading...</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <div class="analytics-item">
                                                        <i class="fas fa-server text-success me-2"></i>
                                                        <strong>Operations Executed:</strong>
                                                        <span id="operationsCount">0</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <div class="analytics-item">
                                                        <i class="fas fa-terminal text-info me-2"></i>
                                                        <strong>Commands Run:</strong>
                                                        <span id="commandsExecuted">0</span>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="analytics-item">
                                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                        <strong>Error Rate:</strong>
                                                        <span id="errorRate">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-download"></i> Export & Actions
                                            </h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <button class="btn btn-primary me-2" onclick="exportCommandLog()">
                                                <i class="fas fa-file-export me-1"></i>
                                                Export Command Log
                                            </button>
                                            <button class="btn btn-success me-2" onclick="exportAnalytics()">
                                                <i class="fas fa-chart-bar me-1"></i>
                                                Export Analytics
                                            </button>
                                            <button class="btn btn-secondary" onclick="resetSessionStats()">
                                                <i class="fas fa-refresh me-1"></i>
                                                Reset Session
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Debug Tab -->
                        <div class="tab-pane fade" id="debug" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-bug"></i> Debug Information
                                            </h5>
                                            <div>
                                                <button id="clearDebugBtn" class="btn btn-sm btn-outline-danger me-2">
                                                    <i class="fas fa-trash"></i> Clear Debug
                                                </button>
                                                <button id="exportDebugBtn" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-download"></i> Export Debug
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0">
                                                                <i class="fas fa-info-circle text-info"></i> System Info
                                                            </h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="systemDebugInfo">
                                                                <div class="debug-item">
                                                                    <strong>Session Started:</strong>
                                                                    <span id="sessionStartTime"></span>
                                                                </div>
                                                                <div class="debug-item">
                                                                    <strong>Operations Count:</strong>
                                                                    <span id="operationsCount">0</span>
                                                                </div>
                                                                <div class="debug-item">
                                                                    <strong>Commands Executed:</strong>
                                                                    <span id="commandsExecuted">0</span>
                                                                </div>
                                                                <div class="debug-item">
                                                                    <strong>Errors:</strong>
                                                                    <span id="errorsCount">0</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0">
                                                                <i class="fas fa-stream text-primary"></i> Debug Log
                                                            </h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="debugLogContainer" style="height: 400px; overflow-y: auto;">
                                                                <div class="text-center text-muted">
                                                                    <i class="fas fa-bug fa-3x mb-3"></i>
                                                                    <p>Debug information will appear here during operations.</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Info Tab -->
                        <div class="tab-pane fade" id="system-info" role="tabpanel">
                            <div class="row mt-3">
                                <!-- Loading Status Column -->
                                <div class="col-md-4">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-microchip text-primary"></i> GPU Data Loading Status
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="gpuLoadingStatus">
                                                <div class="system-info-item">
                                                    <strong>GPU Types:</strong>
                                                    <span id="gpuTypesStatus">
                                                        <i class="fas fa-spinner fa-spin text-warning"></i> Loading...
                                                    </span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Parallel Data Collection:</strong>
                                                    <span id="parallelDataStatus">
                                                        <i class="fas fa-spinner fa-spin text-info"></i> In progress...
                                                    </span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Cache Status:</strong>
                                                    <span id="systemCacheStatus">
                                                        <i class="fas fa-database text-secondary"></i> Initializing...
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-network-wired text-info"></i> NetBox Information
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="netboxInfo">
                                                <div class="system-info-item">
                                                    <strong>Connection:</strong>
                                                    <span id="netboxConnection">
                                                        <i class="fas fa-spinner fa-spin text-warning"></i> Checking...
                                                    </span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Total Devices:</strong>
                                                    <span id="netboxDevices">0</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>API Response Time:</strong>
                                                    <span id="netboxResponseTime">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Last Sync:</strong>
                                                    <span id="netboxLastSync">Never</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-clock text-warning"></i> Performance Metrics
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="performanceMetrics">
                                                <div class="system-info-item">
                                                    <strong>Session Duration:</strong>
                                                    <span id="sessionDuration">0s</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Last Update:</strong>
                                                    <span id="lastUpdateTime">Never</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Cache Age:</strong>
                                                    <span id="cacheAge">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Load Time:</strong>
                                                    <span id="totalLoadTime">N/A</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Statistics Column -->
                                <div class="col-md-4">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-line text-success"></i> System Statistics
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="systemStats">
                                                <div class="system-info-item">
                                                    <strong>Parallel Data:</strong>
                                                    <span id="parallelStats">Parallel: 0 hosts, 0 aggs, 0 types</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Cache Info:</strong>
                                                    <span id="cacheStats">(0 host cache, 0 netbox, 0 parallel)</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Active GPU Type:</strong>
                                                    <span id="activeGpuType">None selected</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Available Types:</strong>
                                                    <span id="availableGpuTypes">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-server text-primary"></i> OpenStack Information
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="openstackInfo">
                                                <div class="system-info-item">
                                                    <strong>Connection:</strong>
                                                    <span id="openstackConnection">
                                                        <i class="fas fa-spinner fa-spin text-warning"></i> Checking...
                                                    </span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Region:</strong>
                                                    <span id="openstackRegion">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Project:</strong>
                                                    <span id="openstackProject">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>API Version:</strong>
                                                    <span id="openstackVersion">N/A</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-cubes text-info"></i> Hyperstack Integration
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="hyperstackInfo">
                                                <div class="system-info-item">
                                                    <strong>API Status:</strong>
                                                    <span id="hyperstackStatus">Unknown</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Firewall Rules:</strong>
                                                    <span id="hyperstackFirewall">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Available Flavors:</strong>
                                                    <span id="hyperstackFlavors">0</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Last Response:</strong>
                                                    <span id="hyperstackLastResponse">Never</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detailed Breakdown Column -->
                                <div class="col-md-4">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-layer-group text-warning"></i> Aggregate Breakdown
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="aggregateBreakdown">
                                                <div class="system-info-item">
                                                    <strong>On-Demand:</strong>
                                                    <span id="ondemandAggregates">0 aggregates</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Spot Instances:</strong>
                                                    <span id="spotAggregates">0 aggregates</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>RunPod:</strong>
                                                    <span id="runpodAggregates">0 aggregates</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Contracts:</strong>
                                                    <span id="contractAggregates">0 aggregates</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-file-contract text-success"></i> Contract Details
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="contractDetails">
                                                <div class="system-info-item">
                                                    <strong>Active Contracts:</strong>
                                                    <span id="activeContracts">0</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Contract Types:</strong>
                                                    <span id="contractTypes">N/A</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Available Hosts:</strong>
                                                    <span id="contractHostsSystemInfo">0</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Utilization:</strong>
                                                    <span id="contractUtilization">N/A</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-database text-secondary"></i> Cache Details
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="cacheDetails">
                                                <div class="system-info-item">
                                                    <strong>Host Cache:</strong>
                                                    <span id="hostCacheDetails">0 entries</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>NetBox Cache:</strong>
                                                    <span id="netboxCacheDetails">0 entries</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Parallel Cache:</strong>
                                                    <span id="parallelCacheDetails">0 entries</span>
                                                </div>
                                                <div class="system-info-item">
                                                    <strong>Cache TTL:</strong>
                                                    <span id="cacheTtl">10 minutes</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VM Details Modal -->
    <div class="modal fade" id="vmDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">GPUs on Host</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="vmDetailsBody">
                    <!-- VM details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Preview Modal -->
    <div class="modal fade" id="migrationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Migration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="migrationWarning" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This host has running VMs!
                    </div>
                    <p>The following OpenStack commands will be executed:</p>
                    <div id="commandPreview" class="bg-light p-3 rounded">
                        <!-- Commands will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmMigrationBtn">Execute Migration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RunPod Image Selection Modal -->
    <div class="modal fade" id="imageSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-compact-disc me-2"></i>
                        Select VM Image for <span id="imageSelectionHostname"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="imageSelectionLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading images...</span>
                        </div>
                        <p class="mt-2">Loading available images...</p>
                    </div>
                    
                    <div id="imageSelectionContent" style="display: none;">
                        <div class="mb-3">
                            <p class="mb-3">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                Select a VM image for deployment. Each image includes different software configurations and GPU drivers.
                            </p>
                            
                            <!-- Region Filter Tabs -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">
                                        <i class="fas fa-globe me-2"></i>Region Filter
                                    </h6>
                                    <small class="text-muted" id="regionDetectionInfo"></small>
                                </div>
                                <div class="btn-group w-100" role="group" id="regionFilterButtons">
                                    <!-- Region buttons will be created dynamically based on API response -->
                                    <div class="text-center text-muted py-2">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading regions...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group mb-3">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="imageSearchInput" placeholder="Search images by name or type...">
                            </div>
                        </div>
                        
                        <div id="imageSelectionList" class="image-selection-container" style="max-height: 400px; overflow-y: auto;">
                            <!-- Images will be loaded here -->
                        </div>
                        
                        <div id="selectedImageInfo" class="mt-3 p-3 bg-light rounded" style="display: none;">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>Selected Image:</h6>
                            <div id="selectedImageDetails"></div>
                        </div>
                        
                        <div id="imageSelectionError" class="alert alert-danger d-none">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="imageSelectionErrorMessage"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="refreshImagesBtn">
                        <i class="fas fa-sync me-1"></i>Refresh Images
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmImageSelectionBtn" disabled>
                        <i class="fas fa-rocket me-1"></i>Launch VM
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Notification message -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Modular JavaScript files -->
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <script src="{{ url_for('static', filename='logs.js') }}"></script>
    <script src="{{ url_for('static', filename='cache-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='hyperstack.js') }}"></script>
    <script src="{{ url_for('static', filename='openstack.js') }}"></script>
    <script src="{{ url_for('static', filename='system-info.js') }}"></script>
    <script src="{{ url_for('static', filename='banner.js') }}"></script>
    <script src="{{ url_for('static', filename='frontend.js') }}"></script>
    
    <!-- Column Architecture (v0.2) -->
    <script src="{{ url_for('static', filename='columns/column-base.js') }}"></script>
    <script src="{{ url_for('static', filename='columns/runpod-column.js') }}"></script>
    <script src="{{ url_for('static', filename='columns/spot-column.js') }}"></script>
    <script src="{{ url_for('static', filename='columns/ondemand-column.js') }}"></script>
    <script src="{{ url_for('static', filename='columns/contract-column.js') }}"></script>
    <script src="{{ url_for('static', filename='columns/outofstock-column.js') }}"></script>

    <!-- Global Search Module -->
    <script src="{{ url_for('static', filename='global-search.js') }}"></script>

    <!-- New UI Controls -->
    <script src="{{ url_for('static', filename='new-ui-controls.js') }}"></script>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='customer-view.js') }}"></script>
    
    <!-- Enhanced Progress Modal for Data Refresh -->
    <div id="refreshProgressModal" class="modal fade" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sync-alt fa-spin text-primary"></i> Refreshing All Data
                    </h5>
                </div>
                <div class="modal-body">
                    <!-- Overall Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="progress-stage" class="fw-bold">Initializing...</span>
                            <span id="progress-percent" class="text-muted">0%</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 style="width: 0%" role="progressbar"></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Steps -->
                    <div class="progress-steps">
                        <div class="step d-flex align-items-center mb-2" id="step-clearing">
                            <i class="fas fa-circle-notch fa-spin text-primary me-3"></i>
                            <span class="flex-grow-1">Clearing caches...</span>
                            <small class="text-muted">~1s</small>
                        </div>
                        <div class="step d-flex align-items-center mb-2" id="step-netbox">
                            <i class="fas fa-circle text-muted me-3"></i>
                            <span class="flex-grow-1">NetBox devices <small class="text-muted" id="netbox-count-hint">Loading...</small></span>
                            <small class="text-muted">~7s</small>
                        </div>
                        <div class="step d-flex align-items-center mb-2" id="step-openstack">
                            <i class="fas fa-circle text-muted me-3"></i>
                            <span class="flex-grow-1">OpenStack aggregates <small class="text-muted" id="aggregates-count-hint">Loading...</small></span>
                            <small class="text-muted">~1s</small>
                        </div>
                        <div class="step d-flex align-items-center mb-2" id="step-vms">
                            <i class="fas fa-circle text-muted me-3"></i>
                            <span class="flex-grow-1">VM counts <small class="text-muted" id="vms-count-hint">Loading...</small></span>
                            <small class="text-muted">~8s</small>
                        </div>
                        <div class="step d-flex align-items-center mb-2" id="step-gpus">
                            <i class="fas fa-circle text-muted me-3"></i>
                            <span class="flex-grow-1">GPU usage <small class="text-muted" id="gpus-count-hint">Loading...</small></span>
                            <small class="text-muted">~1s</small>
                        </div>
                        <div class="step d-flex align-items-center mb-2" id="step-organizing">
                            <i class="fas fa-circle text-muted me-3"></i>
                            <span class="flex-grow-1">Organizing data by GPU types...</span>
                            <small class="text-muted">~1s</small>
                        </div>
                    </div>
                    
                    <!-- Estimated Time -->
                    <div class="mt-4 pt-3 border-top d-flex justify-content-between text-muted">
                        <div>
                            <i class="fas fa-clock me-1"></i>
                            Estimated time: <span id="estimated-time">~16 seconds</span>
                        </div>
                        <div>
                            Elapsed: <span id="elapsed-time">0s</span>
                        </div>
                    </div>
                    
                    <!-- Performance Note -->
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            Refreshing all data from OpenStack, NetBox, and parallel agents for accuracy
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Out of Stock Reasons Legend Modal -->
    <div class="modal fade" id="outofstockLegendModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Out of Stock Reasons
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4 text-muted">
                        Servers appear in the "Out of Stock" column when they cannot be used for new deployments.
                        Here are the possible reasons:
                    </p>

                    <div class="row">
                        <!-- NetBox Status Reasons -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="fas fa-database me-2"></i>NetBox Status
                            </h6>

                            <div class="mb-3">
                                <span class="badge bg-warning text-dark me-2">RMA</span>
                                <small>Hardware under Return Merchandise Authorization - being repaired or replaced</small>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-secondary me-2">Inventory</span>
                                <small>Device in inventory but not yet deployed to production</small>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-dark me-2">Offline</span>
                                <small>Device is powered off or unreachable</small>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-danger me-2">Failed</span>
                                <small>Device has failed hardware or system issues</small>
                            </div>
                        </div>

                        <!-- OpenStack & System Reasons -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success mb-3">
                                <i class="fas fa-cloud me-2"></i>OpenStack & System
                            </h6>

                            <div class="mb-3">
                                <span class="badge bg-info me-2">No Aggregate</span>
                                <small>Host not assigned to any OpenStack aggregate (not schedulable)</small>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-warning text-dark me-2">Unknown GPU</span>
                                <small>GPU type could not be determined from hostname pattern</small>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-primary me-2">Hypervisor Down</span>
                                <small>OpenStack hypervisor service is down or unreachable</small>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Special Conditions -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="fw-bold text-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Special Conditions
                            </h6>

                            <div class="alert alert-warning">
                                <strong>DUPLICATE:</strong> Host appears in multiple columns due to data inconsistency -
                                may be tagged incorrectly in NetBox or have conflicting OpenStack state
                            </div>

                            <div class="alert alert-info">
                                <strong>Full Capacity:</strong> All GPUs are already allocated to running VMs -
                                no capacity for new deployments
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Accountability -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-chart-pie me-2"></i>Inventory Accountability
                        </h6>
                        <small class="text-muted">
                            The system validates that NetBox device count matches UI column totals to ensure
                            100% device accountability. Any discrepancies indicate data synchronization issues
                            that need investigation.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>